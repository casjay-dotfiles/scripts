FROM casjaysdev/almalinux:latest

# Install systemd
RUN yum install -yy systemd bash

# Copy scripts directly without running install.sh
COPY bin /usr/local/share/CasjaysDev/scripts/bin
COPY completions /usr/local/share/CasjaysDev/scripts/completions
COPY man /usr/local/share/CasjaysDev/scripts/man
COPY functions /usr/local/share/CasjaysDev/scripts/functions

# Make scripts executable
RUN chmod +x /usr/local/share/CasjaysDev/scripts/bin/*

# Create symlinks for main scripts
RUN ln -sf /usr/local/share/CasjaysDev/scripts/bin/setupmgr /usr/local/bin/setupmgr

# Enable systemd
RUN systemctl set-default multi-user.target && \
    systemctl mask systemd-udev-trigger.service systemd-udevd.service

# Add labels and metadata
LABEL maintainer="Jason Hempstead <jason@casjaysdev.pro>"
LABEL org.opencontainers.image.title="CasjaysDev Scripts - Development"
LABEL org.opencontainers.image.description="Development container with local scripts (not installed from repository)"
LABEL org.opencontainers.image.version="202510070543-git"
LABEL org.opencontainers.image.authors="Jason Hempstead <jason@casjaysdev.pro>"
LABEL org.opencontainers.image.vendor="CasjaysDev"
LABEL org.opencontainers.image.licenses="WTFPL"
LABEL org.opencontainers.image.url="https://github.com/casjay-dotfiles/scripts"
LABEL org.opencontainers.image.source="https://github.com/casjay-dotfiles/scripts"
LABEL org.opencontainers.image.documentation="https://github.com/casjay-dotfiles/scripts/blob/main/README.md"
LABEL org.opencontainers.image.base.name="casjaysdev/almalinux:latest"

# Set working directory
WORKDIR /root

# Add health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD setupmgr --version || exit 1

# start systemd init
ENTRYPOINT ["/sbin/init"]
# Keep container running with a persistent process
CMD ["bash", "-c", "while true; do sleep 30; done"]
