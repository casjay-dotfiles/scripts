# Override LC and LANG
set-environment -g LANG 'en_US.UTF-8'
set-environment -g LC_ALL 'en_US.UTF-8'
set-environment -g LC_CTYPE 'en_US.UTF-8'

# Set the prefix to Ctrl+Space
unbind C-b
set-option -g prefix C-Space
bind-key C-Space send-prefix

# nested tmux, obey me
bind-key Space send-prefix

# set default shell
set -g default-command bash

# Dracula theme colors (simplified)
color_bg="#282a36"
color_fg="#f8f8f2"
color_purple="#bd93f9"
color_comment="#6272a4"
color_cyan="#8be9fd"
color_green="#50fa7b"
color_yellow="#f1fa8c"
color_red="#ff5555"

# Basic options
set-option -g default-terminal "screen-256color"
set-option -ga terminal-overrides ",xterm-256color:Tc"
set-option -g history-limit 10000
set-option -g base-index 1
set-window-option -g pane-base-index 1
set-window-option -g renumber-windows on
set-option -sg escape-time 0
set-window-option -g mode-keys vi

# Remap keys to my settings
unbind-key d        ; bind-key d        detach-client
unbind-key Tab      ; bind-key Tab      choose-tree -s
unbind-key BTab     ; bind-key BTab     choose-tree -Zw
unbind-key t        ; bind-key t        new-window
unbind-key `        ; bind-key `        last-window
unbind-key n        ; bind-key n        next-window
unbind-key p        ; bind-key p        previous-window

# Window selection
unbind-key 1        ; bind-key 1        select-window -t 1
unbind-key 2        ; bind-key 2        select-window -t 2
unbind-key 3        ; bind-key 3        select-window -t 3
unbind-key 4        ; bind-key 4        select-window -t 4
unbind-key 5        ; bind-key 5        select-window -t 5
unbind-key 6        ; bind-key 6        select-window -t 6
unbind-key 7        ; bind-key 7        select-window -t 7
unbind-key 8        ; bind-key 8        select-window -t 8
unbind-key 9        ; bind-key 9        select-window -t 9

# Window splitting
unbind-key \        ; bind-key \        split-window -c "#{pane_current_path}" -h
unbind-key /        ; bind-key /        split-window -c "#{pane_current_path}" -v

# Pane selection and resizing
unbind-key left     ; bind-key left     select-pane -L
unbind-key up       ; bind-key up       select-pane -U
unbind-key down     ; bind-key down     select-pane -D
unbind-key right    ; bind-key right    select-pane -R
unbind-key C-h      ; bind-key C-h      select-pane -L
unbind-key C-k      ; bind-key C-k      select-pane -U
unbind-key C-j      ; bind-key C-j      select-pane -D
unbind-key C-l      ; bind-key C-l      select-pane -R
unbind-key j        ; bind-key -r j     resize-pane -D 5
unbind-key k        ; bind-key -r k     resize-pane -U 5
unbind-key h        ; bind-key -r h     resize-pane -L 5
unbind-key l        ; bind-key -r l     resize-pane -R 5
unbind-key C-left   ; bind-key -r C-left    resize-pane -L 1
unbind-key C-right  ; bind-key -r C-right   resize-pane -R 1
unbind-key C-up     ; bind-key -r C-up  resize-pane -U 1
unbind-key C-down   ; bind-key -r C-down    resize-pane -D 1
unbind-key @        ; bind-key @        confirm-before kill-window
unbind-key ?        ; bind-key ?        display-popup -E -w 90% -h 90% "cat <<'TMUX_HELP' | less -R
╔══════════════════════════════════════════════════════════════════════════════╗
║                          TMUX KEYBINDINGS REFERENCE                          ║
╚══════════════════════════════════════════════════════════════════════════════╝

PREFIX: Ctrl+Space (or Ctrl+Space Space for nested tmux)

┌─ SESSION MANAGEMENT ──────────────────────────────────────────────────────────┐
│ PREFIX d           Detach from session                                        │
│ PREFIX \$           Rename current session                                     │
│ PREFIX s           Choose session from list                                   │
│ PREFIX N           Create new single session (prompts for name)               │
└───────────────────────────────────────────────────────────────────────────────┘

┌─ WINDOW MANAGEMENT ───────────────────────────────────────────────────────────┐
│ PREFIX t           Create new window                                          │
│ PREFIX c           Create new window (retain current directory)               │
│ PREFIX n           Next window                                                │
│ PREFIX p           Previous window                                            │
│ PREFIX \`           Last window                                                │
│ PREFIX Tab         Choose session (sessions only)                             │
│ PREFIX Shift+Tab   Choose window (current session only)                     │
│ PREFIX ,           Rename current window                                      │
│ PREFIX @           Kill current window (with confirmation)                    │
│ PREFIX 1-9         Switch to window 1-9                                       │
│ Shift+Left         Previous window (no prefix)                                │
│ Shift+Right        Next window (no prefix)                                    │
└───────────────────────────────────────────────────────────────────────────────┘

┌─ PANE MANAGEMENT ─────────────────────────────────────────────────────────────┐
│ PREFIX \\           Split pane horizontally (retain current directory)        │
│ PREFIX /           Split pane vertically (retain current directory)           │
│ PREFIX ←↑↓→        Select pane (arrow keys)                                   │
│ PREFIX h j k l     Select pane (vim keys)                                     │
│ PREFIX +           Zoom/unzoom pane                                           │
│ PREFIX w           Choose pane layout                                         │
│ PREFIX x           Kill current pane                                          │
│ Ctrl+h j k l       Navigate panes (vim-tmux-navigator, no prefix)            │
└───────────────────────────────────────────────────────────────────────────────┘

┌─ PANE RESIZING ───────────────────────────────────────────────────────────────┐
│ PREFIX h           Resize pane left (5 units)                                 │
│ PREFIX j           Resize pane down (5 units)                                 │
│ PREFIX k           Resize pane up (5 units)                                   │
│ PREFIX l           Resize pane right (5 units)                                │
│ PREFIX Ctrl+←↑↓→   Resize pane 1 unit                                         │
└───────────────────────────────────────────────────────────────────────────────┘

┌─ COPY MODE & CLIPBOARD ───────────────────────────────────────────────────────┐
│ PREFIX [           Enter copy mode                                            │
│ PREFIX ]           Paste buffer                                               │
│ PREFIX Ctrl+v      Paste from system clipboard                                │
│ (in copy mode)                                                                │
│   Space            Begin selection                                            │
│   Enter            Copy selection                                             │
│   Ctrl+c           Copy to system clipboard                                   │
│   v                Begin selection (vim mode)                                 │
│   y                Copy selection (vim mode)                                  │
│   Mouse drag       Select and copy                                            │
└───────────────────────────────────────────────────────────────────────────────┘

┌─ SPECIAL FEATURES ────────────────────────────────────────────────────────────┐
│ PREFIX m           Toggle mouse mode on/off                                   │
│ PREFIX s           Toggle pane synchronization                                │
│ PREFIX t           Open file tree sidebar                                     │
│ PREFIX T           Focus file tree sidebar                                    │
│ PREFIX R           Reload tmux configuration                                  │
│ PREFIX Ctrl+s      Save session (resurrect)                                   │
│ PREFIX Ctrl+r      Restore session (resurrect)                                │
│ PREFIX Ctrl+p      Send command to all panes                                  │
└───────────────────────────────────────────────────────────────────────────────┘

┌─ MOUSE SUPPORT ───────────────────────────────────────────────────────────────┐
│ Scroll             Scroll through history (natural scrolling)                 │
│ Click              Select pane                                                │
│ Drag border        Resize pane                                                │
│ Double-click       Select word                                                │
│ Right-click        Open context menu                                          │
└───────────────────────────────────────────────────────────────────────────────┘

Use arrow keys or j/k to scroll • Press 'q' to close
TMUX_HELP
"

# new window and retain cwd
bind-key c new-window -c "#{pane_current_path}"

# Set that stupid Esc-Wait off, so VI works again
set-option -sg  escape-time 0

# set mode either vi or emacs
set-window-option -g mode-keys vi

# Source setup file
bind-key R source-file ~/.config/tmux/simple.conf \; display-message 'Reloaded ~/.config/tmux/simple.conf'

# Create new single session
bind-key N command-prompt -p "New session name:" "run-shell 'tmux-new --dir \"#{pane_current_path}\" single %1 &>/dev/null &'"

# Shift arrow to switch windows
bind -n S-Left  previous-window
bind -n S-Right next-window

# Clipboard integration
# For Linux (X11)
if-shell "command -v xclip" {
    bind-key -T copy-mode C-c send-keys -X copy-pipe-and-cancel "xclip -i -sel clipboard"
    bind-key -T copy-mode MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "xclip -i -sel clipboard"
    bind-key C-v run "xclip -o -sel clipboard | tmux load-buffer - ; tmux paste-buffer"
}

# For Linux (Wayland)
if-shell "command -v wl-copy" {
    bind-key -T copy-mode C-c send-keys -X copy-pipe-and-cancel "wl-copy"
    bind-key -T copy-mode MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "wl-copy"
    bind-key C-v run "wl-paste | tmux load-buffer - ; tmux paste-buffer"
}

# For macOS
if-shell "command -v pbcopy" {
    bind-key -T copy-mode C-c send-keys -X copy-pipe-and-cancel "pbcopy"
    bind-key -T copy-mode MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"
    bind-key C-v run "pbpaste | tmux load-buffer - ; tmux paste-buffer"
}

# Mouse support with proper scrollback (disabled by default)
set -g mouse off

# Toggle mouse
unbind-key m ; bind-key m if-shell '[ "$(tmux show -gv mouse)" = "on" ]' 'set -g mouse off; display-message "Mouse: OFF"' 'set -g mouse on; display-message "Mouse: ON"'

# Natural mouse scrolling - no weird characters
bind-key -n WheelUpPane if-shell -F -t = "#{alternate_on}" "send-keys -M" "select-pane -t =; copy-mode -e; send-keys -M"
bind-key -n WheelDownPane select-pane -t = \; send-keys -M

# In copy mode, scroll smoothly
bind-key -T copy-mode WheelUpPane send-keys -X -N 3 scroll-up
bind-key -T copy-mode WheelDownPane send-keys -X -N 3 scroll-down
bind-key -T copy-mode-vi WheelUpPane send-keys -X -N 3 scroll-up
bind-key -T copy-mode-vi WheelDownPane send-keys -X -N 3 scroll-down

# Disable mouse drag to prevent accidental copy mode
unbind-key -n MouseDrag1Pane

# Select layout
bind-key w command-prompt -p "tiled/even-horizontal/even-vertical/main-horizontal/main-vertical?"  "select-layout '%%'"

# Zoom tmux pane with '+' key
bind + resize-pane -Z

# Message display time (ms)
set-option -g display-time 2000

# Sync toggle
unbind-key s ; bind-key s set-window-option synchronize-panes\; display-message "synchronize-panes is now #{?pane_synchronized,on,off}"

# Open prompt
unbind-key C-p ; bind C-p command-prompt -p "Command:" "run \"tmux list-panes -a -F '##{session_name}:##{window_index}.##{pane_index}' | xargs -I PANE tmux send-keys -t PANE '%1' Enter\""

# Simple status bar with Dracula theme
set-option -g status on
set-option -g status-position bottom
set-option -g status-justify centre
set-option -g status-style "fg=$color_fg,bg=$color_bg"
set-option -g pane-border-style "fg=$color_comment"
set-option -g pane-active-border-style "fg=$color_purple"

# Window status
set-window-option -g window-status-format "#[fg=$color_comment] #I:#W "
set-window-option -g window-status-current-format "#[fg=$color_purple,bold] #I:#W "

# Simplified status bar with prefix indicator
set -g status-left "#[fg=$color_bg,bg=#{?client_prefix,$color_green,$color_comment}] #{?client_prefix,PRE,TMX} #[fg=$color_cyan,bg=$color_bg] #S "
set -g status-right "#[fg=$color_cyan] %H:%M "
